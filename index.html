<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦‹ç©ã‚‚ã‚Šãƒ•ã‚©ãƒ¼ãƒ </title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f5f6f8; margin: 0; padding: 20px; color: #333; padding-bottom: 100px; }
        h2 { text-align: center; color: #111; margin-bottom: 20px; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-name { font-weight: bold; font-size: 16px; }
        .item-price { font-size: 13px; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; }
        
        /* å…¥åŠ›ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ */
        select, input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; background: #fff; box-sizing: border-box; -webkit-appearance: none; }
        
        /* è‡ªç”±å…¥åŠ›æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå…¥åŠ›æ  + å˜ä½ï¼‰ */
        .input-group { display: flex; align-items: center; gap: 10px; }
        .input-group input { text-align: right; font-weight: bold; }
        .unit-label { font-size: 14px; color: #555; white-space: nowrap; }

        .btn-area { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: white; border-top: 1px solid #eee; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #06C755; color: white; border: none; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        button.active { opacity: 1; pointer-events: auto; }
        
        #loader { text-align: center; margin-top: 50px; font-weight: bold; color: #666; }
    </style>
</head>
<body>
    <h2>ğŸ“‹ ãŠè¦‹ç©ã‚Šä½œæˆ</h2>
    
    <div id="loader">ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ä¸­...</div>
    <form id="orderForm" style="display:none;"></form>

    <div class="btn-area">
        <button id="sendBtn" onclick="sendOrder()">èª­ã¿è¾¼ã¿ä¸­...</button>
    </div>

    <script>
        // â˜…LIFF ID (GitHub Pagesç”¨)
        const LIFF_ID = "2009089391-BXK3sGbW";
        
        // â˜…ã“ã“ã«ã€Œè¦ªGASï¼ˆçµ±æ‹¬GASï¼‰ã€ã®æ–°ã—ã„ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã£ã¦ãã ã•ã„
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxIimc8ShnuABblD5RQkHiDvaU6PEWYJbW0rqDVSNfE_HfL8DW2xDk6FK_2PUYYHcZV/exec";

        let items = [];

        // LIFFåˆæœŸåŒ– & ãƒ‡ãƒ¼ã‚¿å–å¾—
        window.onload = async function() {
            try {
                // 1. LIFFåˆæœŸåŒ–
                await liff.init({ liffId: LIFF_ID });

                // 2. æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return; 
                }

                // 3. UserIDã‚’å–å¾—
                const context = liff.getContext();
                const userId = context.userId;

                if (!userId) {
                    throw new Error("UserIDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
                }

                document.getElementById("loader").innerText = "å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...";

                // 4. GASã¸å•ã„åˆã‚ã› (userIdã‚’ä»˜ä¸)
                const fetchUrl = `${GAS_API_URL}?userId=${userId}`;
                
                const response = await fetch(fetchUrl);
                const data = await response.json();

                // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (!Array.isArray(data)) {
                    if (data.error) {
                        throw new Error("GASã‚¨ãƒ©ãƒ¼: " + data.error);
                    } else {
                        throw new Error("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™");
                    }
                }

                // æˆåŠŸæ™‚
                items = data;
                
                // ç”»é¢ç”Ÿæˆ
                renderForm();
                document.getElementById("loader").style.display = "none";
                document.getElementById("orderForm").style.display = "block";
                
                checkForm();

            } catch (err) {
                alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
                document.getElementById("loader").innerText = "èª­ã¿è¾¼ã¿å¤±æ•—: " + err.message;
            }
        };

        // ãƒ•ã‚©ãƒ¼ãƒ æç”»
        function renderForm() {
            const form = document.getElementById("orderForm");
            items.forEach(item => {
                let inputHtml = '';
                
                // â˜…å¤‰æ›´ç‚¹: ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦è¡¨ç¤ºã‚’åˆ†å²
                if (item.type === 'select' || item.type === 'boolean') {
                    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆã‚ã‚Š/ãªã—ï¼‰
                    inputHtml = `<select name="${item.id}" onchange="checkForm()">
                        <option value="0">ä¸è¦</option>
                        <option value="1">å¿…è¦ (+Â¥${item.price.toLocaleString()})</option>
                    </select>`;
                } else {
                    // â˜…ã“ã“ã‚’ä¿®æ­£: è‡ªç”±å…¥åŠ›ï¼ˆinput type="number"ï¼‰ã«å¤‰æ›´
                    inputHtml = `<div class="input-group">
                        <input type="number" name="${item.id}" value="0" min="0" placeholder="0" oninput="checkForm()">
                        <span class="unit-label">${item.unit}</span>
                    </div>`;
                }

                const html = `
                    <div class="card">
                        <div class="label-row">
                            <span class="item-name">${item.name}</span>
                            <span class="item-price">Â¥${item.price.toLocaleString()}</span>
                        </div>
                        ${inputHtml}
                    </div>`;
                form.insertAdjacentHTML('beforeend', html);
            });
        }

        // å…¥åŠ›ãƒã‚§ãƒƒã‚¯ (select ã¨ input ã®ä¸¡æ–¹ã‚’ç›£è¦–)
        function checkForm() {
            const inputs = document.querySelectorAll('select, input');
            let hasValue = false;
            inputs.forEach(input => {
                if (parseInt(input.value) > 0) hasValue = true;
            });
            const btn = document.getElementById("sendBtn");
            
            if (hasValue && liff.isInClient()) {
                btn.classList.add("active");
                btn.innerText = "LINEã«é€ä¿¡ã—ã¦è¨ˆç®—";
            } else if (!liff.isInClient()) {
                btn.innerText = "LINEã‚¢ãƒ—ãƒªã‹ã‚‰é–‹ã„ã¦ãã ã•ã„";
            } else {
                btn.classList.remove("active");
                btn.innerText = "å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„";
            }
        }

        // é€ä¿¡å‡¦ç† (æ—¥æœ¬èªå¯¾å¿œç‰ˆ)
        async function sendOrder() {
            const inputs = document.querySelectorAll('select, input');
            let lines = [];
            
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if (val > 0) {
                    // IDã‹ã‚‰å•†å“æƒ…å ±ã‚’æ¢ã™
                    const item = items.find(i => i.id === input.name);
                    
                    if (item) {
                        let displayValue = val;
                        // ãƒ–ãƒ¼ãƒ«å‹ã®å ´åˆã¯ã€Œã‚ã‚Šã€ã«å¤‰æ›
                        if (item.type === 'boolean' || item.type === 'select') {
                             displayValue = "ã‚ã‚Š";
                        }
                        
                        // ã€Œå•†å“å : å€¤ã€ã®å½¢å¼ã§è¿½åŠ 
                        lines.push(`${item.name}:${displayValue}`);
                    }
                }
            });

            if (lines.length === 0) {
                alert("å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã¦é€ä¿¡
            const text = "ã€ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ã€‘\n" + lines.join("\n");

            try {
                await liff.sendMessages([{ type: 'text', text: text }]);
                liff.closeWindow();
            } catch (err) {
                alert("é€ä¿¡å¤±æ•—: " + err.message);
            }
        }
    </script>
</body>
</html>
