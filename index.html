<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦‹ç©ã‚‚ã‚Šãƒ•ã‚©ãƒ¼ãƒ </title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ãã®ã¾ã¾ç¶­æŒ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f5f6f8; margin: 0; padding: 20px; color: #333; padding-bottom: 100px; }
        h2 { text-align: center; color: #111; margin-bottom: 20px; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-name { font-weight: bold; font-size: 16px; }
        .item-price { font-size: 13px; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; }
        select, input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; background: #fff; box-sizing: border-box; -webkit-appearance: none; }
        
        .btn-area { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: white; border-top: 1px solid #eee; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #06C755; color: white; border: none; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        button.active { opacity: 1; pointer-events: auto; }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºç”¨ */
        #loader { text-align: center; margin-top: 50px; font-weight: bold; color: #666; }
    </style>
</head>
<body>
    <h2>ğŸ“‹ ãŠè¦‹ç©ã‚Šä½œæˆ</h2>
    
    <div id="loader">å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <form id="orderForm" style="display:none;"></form>

    <div class="btn-area">
        <button id="sendBtn" onclick="sendOrder()">èª­ã¿è¾¼ã¿ä¸­...</button>
    </div>

    <script>
        // â˜…LIFF ID (GitHub Pagesç”¨)
        const LIFF_ID = "2009089391-BXK3sGbW";
        
        // â˜…è¦ªGASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL (execã§çµ‚ã‚ã‚‹ã‚‚ã®)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxIimc8ShnuABblD5RQkHiDvaU6PEWYJbW0rqDVSNfE_HfL8DW2xDk6FK_2PUYYHcZV/exec";

        // å•†å“ãƒªã‚¹ãƒˆã‚’å…¥ã‚Œã‚‹å¤‰æ•°
        let items = [];

        // LIFFåˆæœŸåŒ– & ãƒ‡ãƒ¼ã‚¿å–å¾—
        // LIFFåˆæœŸåŒ– & ãƒ‡ãƒ¼ã‚¿å–å¾—
        window.onload = async function() {
            try {
                // 1. LIFFåˆæœŸåŒ–
                await liff.init({ liffId: LIFF_ID });

                // â˜…è¿½åŠ : ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³
                // UserIDãŒãªã„ã¨å•†å“ãƒ‡ãƒ¼ã‚¿ãŒå¼•ã‘ãªã„ãŸã‚
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return; // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é·ç§»ã™ã‚‹ã®ã§ã“ã“ã§çµ‚äº†
                }

                // 2. UserIDã‚’å–å¾—
                const context = liff.getContext();
                const userId = context.userId;

                if (!userId) {
                    throw new Error("UserIDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
                }

                document.getElementById("loader").innerText = "å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...";

                // 3. GASã¸å•ã„åˆã‚ã› (userIdã‚’ä»˜ä¸ï¼)
                // æœ«å°¾ã« ?userId=xxx ã‚’ã¤ã‘ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
                const fetchUrl = `${GAS_API_URL}?userId=${userId}`;
                
                const response = await fetch(fetchUrl);
                const data = await response.json();

                // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (!Array.isArray(data)) {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                    if (data.error) {
                        throw new Error("GASã‚¨ãƒ©ãƒ¼: " + data.error);
                    } else {
                        throw new Error("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™");
                    }
                }

                // æˆåŠŸæ™‚
                items = data;
                
                // 4. ç”»é¢ç”Ÿæˆ
                renderForm();
                document.getElementById("loader").style.display = "none";
                document.getElementById("orderForm").style.display = "block";
                
                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–ãƒã‚§ãƒƒã‚¯
                checkForm();

            } catch (err) {
                alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
                document.getElementById("loader").innerText = "èª­ã¿è¾¼ã¿å¤±æ•—: " + err.message;
            }
        };
        // ãƒ•ã‚©ãƒ¼ãƒ æç”»é–¢æ•°
        function renderForm() {
            const form = document.getElementById("orderForm");
            items.forEach(item => {
                let inputHtml = '';
                // ã‚¿ã‚¤ãƒ—åˆ¤å®š (select: æœ‰ç„¡, number: å€‹æ•°)
                if (item.type === 'select' || item.type === 'boolean') {
                    inputHtml = `<select name="${item.id}" onchange="checkForm()">
                        <option value="0">ä¸è¦</option>
                        <option value="1">å¿…è¦ (+Â¥${item.price.toLocaleString()})</option>
                    </select>`;
                } else {
                    inputHtml = `<select name="${item.id}" onchange="checkForm()">
                        <option value="0">0 ${item.unit}</option>
                        ${[1,2,3,4,5,10].map(n => `<option value="${n}">${n} ${item.unit}</option>`).join('')}
                    </select>`;
                }

                const html = `
                    <div class="card">
                        <div class="label-row">
                            <span class="item-name">${item.name}</span>
                            <span class="item-price">Â¥${item.price.toLocaleString()}</span>
                        </div>
                        ${inputHtml}
                    </div>`;
                form.insertAdjacentHTML('beforeend', html);
            });
        }

        // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
        function checkForm() {
            const inputs = document.querySelectorAll('select');
            let hasValue = false;
            inputs.forEach(input => {
                if (parseInt(input.value) > 0) hasValue = true;
            });
            const btn = document.getElementById("sendBtn");
            
            if (hasValue && liff.isInClient()) {
                btn.classList.add("active");
                btn.innerText = "LINEã«é€ä¿¡ã—ã¦è¨ˆç®—";
            } else if (!liff.isInClient()) {
                btn.innerText = "LINEã‚¢ãƒ—ãƒªã‹ã‚‰é–‹ã„ã¦ãã ã•ã„";
            } else {
                btn.classList.remove("active");
                btn.innerText = "å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„";
            }
        }

        // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: é€ä¿¡å‡¦ç† (ä½™è¨ˆãªæ”¹è¡Œã‚’å‰Šé™¤)
        async function sendOrder() {
            const inputs = document.querySelectorAll('select');
            
            // é…åˆ—ã«ä¸€åº¦æ ¼ç´ã™ã‚‹ã“ã¨ã§ã€æœ€å¾Œã®æ”¹è¡Œã‚’é˜²ã
            let lines = [];
            
            inputs.forEach(input => {
                if (parseInt(input.value) > 0) {
                    lines.push(`${input.name}:${input.value}`);
                }
            });

            // çµåˆ (joinã‚’ä½¿ã†ã¨æœ«å°¾ã«æ”¹è¡ŒãŒå…¥ã‚Šã¾ã›ã‚“)
            const text = "ã€ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ã€‘\n" + lines.join("\n");

            try {
                await liff.sendMessages([{ type: 'text', text: text }]);
                liff.closeWindow();
            } catch (err) {
                alert("é€ä¿¡å¤±æ•—: " + err.message);
            }
        }
    </script>
</body>
</html>
